image: alpine/helm:3.10.2

stages:
  - test
  - package
  - harbor_push

test_chart:
  stage: test
  only: 
    - tags
  script:
    - helm lint $CHART_PATH

packaging:
  stage: package
  only:
    - tags
  script:
    - helm package $CHART_PATH

harbor_pushing:
  stage: harbor_push
  only:
    - tags
  before_script:
    - apk add yq
    - helm plugin install https://github.com/chartmuseum/helm-push
  script:
    - yq -i '.version = "'${CI_COMMIT_TAG}'"' $CHART_PATH/Chart.yaml && cat $CHART_PATH/Chart.yaml
    - helm repo add --username "acrflydev01" --password "A1Z98rkHPpQDF+gvdd3b/CRxt9UCANlkfte0rBJPK1+ACRAg0Boe" gitlab acrflydev01.azurecr.io/chartrepo/gitlab
    - helm cm-push $CHART_PATH gitlab